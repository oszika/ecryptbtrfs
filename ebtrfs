#!/bin/sh

# Load common functions

file=`realpath $0`
dir=`dirname $file`
source $dir/ecryptfs.sh

# Btrfs commands

help()
{
	name=`basename $0`
	echo -e "Using ecryptfs over btrfs"
	echo -e "$name ((create|mount|umount|home|snapshot) <volpath> | list)"
	echo -e "\t create <volpath>:\tcreate new encrypted volume at <volpath>"
	echo -e "\t mount <volpath>:\tmount encrypted volume located at <volpath>"
	echo -e "\t umount <volpath>:\tumount encrypted volume located at <volpath>"
	echo -e "\t snapshot <volpath>:\tcreate snapshot of encrypted volume"
	echo -e "\t list:\tlist encrypted volumes"
	exit -1
}

create() {
	name=`realpath $1`
	volume=`getVolume $name`

	safe btrfs subvolume create "$volume"
	debug "Subvolume $volume created"

	ecryptfs_init $name $volume
}

delete() {
	name=`realpath $1`
	volume=`getVolume $name`

	safe btrfs subvolume delete "$volume"
	safe rmdir $name

	debug "Subvolume $volume deleted"
}

list() {
	btrfs subvolume list $@ | perl -ne 'print "$1/$2\n" if /^(.*)\/\.([^\/]+)\.ecryptfs$/'
}

snapshot() {
	[ $# -eq 0 ] && error "Missing volume to snapshot"
	[ $# -gt 1 ] &&	opts=${@: 1:$#-1}
	src=${@: -1:1}

	# btrfs src
	n_src=`realpath $src`
	v_src=`getVolume $n_src`

	# snaps path
	mkdir -p $v_src/.snaps

	# new snapshot dst
	if [ -e "$v_src/.snaps/init" ]; then
		n_dst="$v_src/.snaps/$(date +%Y-%m-%d-%H:%M:%S)"
	else
		n_dst="$v_src/.snaps/init"
	fi

	v_dst=`getVolume $n_dst`

	debug "Take new snapshot: $n_dst"

	safe mkdir -p $n_dst
	safe chmod 500 $n_dst
	safe btrfs subvolume snapshot $opts $v_src $v_dst
}

cmd=$1
shift

case "$cmd" in
	"create")
		create $1
		;;
	"delete")
		delete $1
		;;
	"mount")
		ecryptfs_mount $1
		;;
	"umount")
		ecryptfs_umount $1
		;;
	"home")
		ecryptfs_home $1
		;;
	"list")
		list $@
		;;
	"snapshot")
		snapshot $@
		;;
	*)
		help
		;;
esac
